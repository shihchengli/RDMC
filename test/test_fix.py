#!/usr/bin/env python3

"""
Unit tests for the mol module.
"""

import pytest

from rdmc import RDKitMol
from rdmc.fix import fix_mol


def test_fix_mol_1():
    xyz = """11

N     -0.6257110000   -0.2593320000   -0.9884930000
C      0.2688160000   -0.8319990000    0.0754190000
O      0.3964400000   -2.0228180000    0.1135550000
C      0.8450220000    0.1995700000    0.9394180000
C      1.6321610000   -0.1480200000    1.9559930000
H     -0.1237010000    0.4381030000   -1.5829470000
H     -0.9963200000   -1.0439920000   -1.5361970000
H      0.6035930000    1.2250590000    0.6918340000
H      1.8315670000   -1.1898640000    2.1796230000
H      2.0878070000    0.6011050000    2.5908840000
O     -1.6323370000    0.4883040000   -0.4054090000"""

    mol = RDKitMol.FromXYZ(xyz, backend="openbabel", sanitize=False)

    with pytest.raises(Exception):
        mol.Sanitize()

    assert fix_mol(mol).ToSmiles() == "C=CC(=O)[NH2+][O-]"


def test_fix_mol_2():
    xyz = """37

C      0.0878700000    1.9457110000    3.8222230000
C      0.3845130000    0.6296420000    3.1095460000
C      0.9579700000    0.8236020000    1.6869360000
C      2.2986750000    1.5504340000    1.6697210000
C      1.0910500000   -0.5190180000    1.0219660000
O      2.0949340000   -1.0733740000    0.6996620000
N     -0.2130960000   -1.2487480000    0.7300530000
H     -0.3850710000    1.7585110000    4.7872470000
H     -0.5904760000    2.5644870000    3.2307820000
H      0.9960200000    2.5201880000    4.0052000000
H     -0.5433040000    0.0539610000    3.0561050000
H      1.0918580000    0.0375120000    3.6988600000
H      0.2328600000    1.3887070000    1.0988110000
H      2.6847060000    1.6127630000    0.6536490000
H      3.0373200000    1.0285160000    2.2805420000
H      2.1842900000    2.5635430000    2.0520890000
H     -0.5907660000   -1.6620990000    1.5910120000
H      0.0517760000   -2.0040840000    0.0539540000
C      1.8317090000    0.6812160000   -2.3476270000
C      0.9480470000    1.7572160000   -1.8340960000
C     -1.1999620000   -0.4862230000   -0.0458380000
C     -2.2254020000    0.3182860000    0.6649800000
C     -1.2230550000   -0.9919480000   -1.3439180000
O     -0.4618060000   -1.8982750000   -1.7471550000
O     -2.1371840000   -0.4099140000   -2.1755100000
C     -2.1593300000   -0.9149810000   -3.5106800000
H      2.0987910000    0.8470850000   -3.4039840000
H      1.3508680000   -0.2970970000   -2.2970340000
H      2.7770430000    0.6305950000   -1.7998070000
H     -0.1255720000    1.6853060000   -1.9370840000
H      1.3607280000    2.7011440000   -1.5006770000
H     -2.6977030000   -0.2332810000    1.4943930000
H     -3.0142990000    0.5713670000   -0.0419550000
H     -1.8625980000    1.2646920000    1.0872720000
H     -2.9200460000   -0.3349620000   -4.0297310000
H     -2.4170940000   -1.9752960000   -3.5264770000
H     -1.1899930000   -0.7837590000   -3.9943770000
"""

    mol = RDKitMol.FromXYZ(xyz, backend="openbabel", sanitize=False)

    with pytest.raises(Exception):
        mol.Sanitize()

    assert set(fix_mol(mol).ToSmiles().split('.')) == {"CCC(C)C(=O)[NH2+][C-](C)C(=O)OC", "[CH2]C"}
